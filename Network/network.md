***
### 1. 分层

OSI 7层和 TCP/IP 5层：
![network layoer](/Image/networkLayer.png)

从一般概念上讲，计算机或网络互连要使用一些中间设备：
- 物理层 —— 转发器
- 数据链路层 —— 网桥或桥接器
- 网络层 —— 路由器
- 网络层以上 —— 网关
转发器和网桥仅仅是把一个网络扩大了，路由器连接网络。

##### 1.1 物理层
1. 为设备之间的数据通信提供传输媒体(电缆、光纤、无线信道)及互连设备。
2. 传输数据(比特流(0, 1)信号)。
##### 1.2 数据链路层
要在一条线路上传递数据，除了必须有一条物理线路外，还必须有一些通信协议来控制这些数据的传输，若把这些实现协议的软件硬件加到物理链路上，就构成了数据链路。

主要功能(为网络层提供数据传送服务)：
1. 封装成帧(frame)：接收端能够从物理层上交的比特流中根据首尾部标记识别出帧，并取出数据
2. 透明传输：无论什么样的比特组合都能够通过，对首尾标识以及转义字符的转义
3. 差错检测：比特在传输过程中可能出错(循环冗余检验)：
    - 在通信质量良好的有线链路，数据链路层丢弃错误帧，即只保证接收的帧无差错，确认和重传由上层协议来完成。(帧比较小，正确率高的情况下每一帧都要确认比较耗费资源)
    - 在通信质量差的无限链路，数据链路层使用确认和重传机制，向上提供可靠传输的服务。(正确率低时，上层数据报频繁重发会使得很多成功发送的帧重发)

数据链路层最常见的独立产品是网卡(计算机MAC地址)，网桥(根据MAC帧的目的地址对收到的帧进行转发和过滤)。

数据链路层的信道主要分为：
1. 点对点信道，PPP协议
2. 广播信道，CSMA/CD协议(以太网)

##### 1.3 网络层
发送数据时，网络层负责把运输层产生的报文段或用户数据报封装成`IP数据报(datagram)`进行传送；另一个任务是选择合适的路由，使得IP数据报能够通过网络中的路由器找到目的主机(也就是路由或寻径)。

网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务，所传送的分组可能出错、丢失、重复和失序。

###### 1.3.1 网际协议IP
网际协议IP是作用是使互连起来的许多计算机网络之间能够进行通信，与之配套使用的还有ARP,ICMP,IGMP。

IP协议可以使各个性能各异的网络在网络层看起来像是一个同一个网络。

IP地址特点：
- IP地址一般有两个部分组成：网络号和主机号。A类、B类和C类地址的区分已成为历史。
- IP地址是32位的二进制代码，为提高可读性，使用点分十进制记法。
- 网络号全0 表示“本网络”，主机号全0表示“本主机”；网络号为 127 保留作为本地软件环回测试本主机的进程之间的通信只用，主机号全 1 表示该网络上的所有主机。B类C类不会出现网络号全为0或1的情况。
- 一个网络指具有相同网络号的主机的集合，因此用转发器或网桥连接起来的若干个局域网仍为一个网络。路由器每一个接口都有一个不同网络号的IP地址(路由器直连时可能不会分配IP地址)。

IP地址与硬件地址(物理地址、MAC地址)：
- 硬件地址是数据链路层和物理层使用的地址，IP地址是网络层及以上使用的地址，是一种逻辑地址。
- 使用IP地址(首部中)的IP数据报在数据链路层被封装成MAC帧，MAC帧在传送时使用的源地址和目的地址都是硬件地址(MAC帧首部中)。
- 在路由器中转发时，IP数据报首部中的源地址和目的地址始终都不会变化，而MAC帧首部中的源地址和目的地址都要发生变化。

网络层抽象的互联网屏蔽了下层复杂的细节，使我们得在网络层上讨论问题时，能够使用统一的、抽象的IP地址研究主机和主机或路由器之间的通信。

###### 1.3.2 ARP
ARP解决的是(同一个局域网上)已知一个机器(主机或路由器)的IP地址，需要找出其相应的硬件地址的问题。

网络层使用的是IP地址，但实际在网络的链路上传送数据帧时，还是必须使用网络的硬件地址。但IP地址和MAC地址由于格式不同而没有简单的映射关系，且主机的加入、撤走，更换网卡都可能导致MAC地址改变。ARP的解决办法就是在主机(路由器)ARP高速缓存中存放本局域网上各主机从IP地址到MAC地址的映射表，且该表经常动态更新(新增或超时删除)。

ARP特点：
- 当一个主机向另一个主机发送数据时，若在映射表中找不到目的主机的IP地址项目，则源主机自动运行ARP,ARP进程在局域网广播发送一个APR请求分组，对应的主机会以单播的形式响应分组。
- ARP把映射表中的每一个项目都设置生存时间，超过生存时间的就删除。
- 从IP地址到硬件地址的解析是自动进行的，主机用户对这种地址解析过程并不知情。只要主机要和本网络上的一个已知IP地址的主机或路由器进行通信，ARP协议就会自动将IP地址解析为MAC地址。

###### 1.3.3 IP数据报格式
IP数据报由首部和数据两部分组成。首部分固定首部和可选字段。固定首部中包含了版本、首部长度、总长度、标识、标志、片偏移、生存时间、协议、首部校验和等字段。

IP数据报分片(一个IP数据报分成多个IP数据报)：
- 总长度字段为 16 位，因此数据报最大长度为 2^16 - 1 字节。而每一种数据链路层协议都规定了一个数据帧中数据字段的最大长度，这称为MTU。若传送的IP数据报长度超过MTU,就必须把过长的数据报进行分片处理。
- 虽然IP数据报越长，传输效率越高(分片少，首部长度占总长度比例小)；但IP数据报越短，路由器转发速度越快。因此IP协议规定路由器和主机必须能接受长度不超过576字节的数据报；若超过，则需要先了解目的主机能否接受该长度，不能就要分片。
- 标识在数据报分片时，会被复制到所有数据报片的标识字段，使得各分片最后能正确重装为原来的数据报。
- 标志占3位，目前两位有意义。最低位记为MF,MF为1表示后面还有分片；MF为0表示已经是分片中的最后一个。中间一位记为DF,DF为1表示不能分片；DF为0表示允许分片。
- 片偏移表示某片在原分组中的相对位置，既相对数据字段的起点。片偏移以8字节为偏移单位，所以每个分片一定是8字节(64位)的整数倍。
- 生存时间TTL，占8位 目的是防止无法交付的数据报无限制的在因特网中兜圈子。TTL 从时间限制(技术进步，路由器处理数据报所需时间不短缩短)改为跳数限制，路由器转发之前将TTL(最大255)减1,若为0 就丢弃。

首部的可选字段增加了路由器处理数据报的开销，而很少被使用，因此IPv6把IP数据报的首部长度做成固定的。

###### 1.3.4 IP层转发分组流程
按照主机号来制作路由表会导致路由表过于庞大，所以按照网络地址来制作。路由表每一行最主要的是目的主机所在网络和下一跳地址，若不需再经过路由器，则可通过接口直接交付(路由器中有ARP映射表)。

其他路由：
- 因特网中所有的分组转发都是基于目的主机坐在网络，但允许有这样的特例：对特定的目的主机指明一个路由，叫做特定主机路由。可使网络管理人员能更方便的控制网络和测试网络，或用在考虑某种安全问题的情况下。
- 路由器可以采用默认路由来减少路由表所占用的空间和搜索路由表所用的时间。这种方式在一个网络只有很少的对外连接时很有用。

分组转发算法：
1. 从数据报首部提取目的主机的IP地址D，得出网络地址N。
2. 若N与路由器直接相连，则直接交付；否则3。
3. 若路由表中有D的特定主机路由，则把数据报传送给路由表中指明的下一跳路由；否则4。
4. 若路由表中有到达N的路由，则把数据报传送给路由表中指明的下一跳路由；否则5。
5. 若路由表中有默认路由，则把数据报传送给路由表中指明默认路由器；否则6。
6. 报告转发分组出错。

###### 1.3.5 划分子网
两级IP地址缺点：
1. 网络地址利用率低。
2. 给每一个物理网络分配一个网络号会使得路由表变得太大(存储空间、查找时间、定期交换的路由信息急剧增加)，而使网络性能变坏。
3. 两级地址不够灵活，开通一个新的网络必须申请到一个新的IP地址。

为了解决两级IP的缺点，在IP地址中又增加了一个“子网段号”，将两级IP地址变成三级IP地址，这就是划分子网。

划分子网思路是：从网络的主机号借用若干位作为子网号，因此即使分配了多个子网，对外依然表现为一个网络。而与网络连接的路由器在收到IP数据报后，再按目的网络号和子网号找到目的子网，把IP数据报交付目的主机。
###### 1.3.6 子网掩码
从IP数据报的首部无法看出源主机或目的主机所连接的网络是否进行了子网划分，因此需要**子网掩码**：
子网掩码也是32位，由一串1(对应网络号和子网号)跟随一串0(对应主机号)组成。

使用子网掩码的好处是：无论网络有无子网，只要把IP地址和子网掩码逐位“与”，就可以立即得到网络地址，路由器可以对到来的分组统一处理。为了便于查找路由表，规定所有的网络都必须使用子网掩码，路由表中也必须有子网掩码这一栏；路由器在和相邻路由器交换信息时(链路层广播?)，也必须把自己所在网络的子网掩码带上。若网络不划分子网，则其子网掩码就是**默认子网掩码**(一串1正好和网络号对应)

使用子网划分后，路由表必须包含：目的网络地址、子网掩码、下一跳地址三项。这时的分组转发算法与**1.3.4**中分组转发类似,只是不再需要网络地址N,并将交付或转发的条件变成检查 “子网掩码和IP地址逐位‘与’的结果与目的网络地址是否匹配”。

###### 1.3.7 无分类编制CIDR(构成超网)
划分子网在缓解了因特网在发展中遇到的困难，但依然有三个必须尽早解决的问题：
1. 网络地址不够，B类地址即将分配完毕。
2. 因特网主干上的路由表项目数量急剧增长。
3. 整个IPv4 地址空间终即将全部耗尽。
其中问题1、2迫在眉睫，IETF 研究出采用**无分类编制**
的方法来解决他们。该方法的正式名字为**无分类域间路由选择CIDR**,它最主要的特点有两个：
1. 消除了A类、B类和C类地址及划分子网(CIDR 不使用子网是指没有在32位中指明若干位作为子网字段，但分配到一个CIDR地址块的单位依然可以在内部根据需要划分出一些子网)的概念。CIDR把32为的IP分为两个部分。IP地址 ::= {<网络前缀>，<主机号>}。CIDR还使用斜线记法，即在IP地址后面加上斜线"/",然后写上网络前缀所占的位数。
2. CIDR把网络前缀都相同的连续的IP地址组成一个CIDR地址块。CIDR使用32位的**地址掩码**，其中1的个数就是网络前缀的长度，CIDR使用的地址掩码也可以继续称为子网掩码。

一个CIDR地址块中有很多地址，在路由表中利用CIDR地址块来查找目的网络，这种地址的聚合常称为**路由聚合**，它使得路由表中的一个项目可以表示原来传统分类地址的很多个路由。路由聚合也称为**构成超网**。CIDR的另一个好处是可以更加有效的分配IPv4的地址空间，而分类地址则只能分配A类、B类和C类。

使用构成超网后的路由匹配特点:
1. 最长匹配前缀
   
   路由表中项目主要由网络前缀、地址掩码和吓一跳地址组成。在查找路由表是可能会得到不止一个匹配结果，这时就应当从匹配结果中选择具有最长网络前缀的路由。
2. 使用二叉线索查找路由表
   
   由于要寻找最长匹配前缀，路由表的查找过程变得更加复杂。为了更加有效的查找，通常是把路由表存放在一种层次的数据结构中，然后自上而下的按层次进行查找。这里最常用的就是**二叉线索**，其每一个叶节点代表一个唯一前缀。二叉线索只是提供了一种可以快速在路由表中找到匹配的叶节点的机制，还需要和子网掩码进行逻辑与运算来确定是否和网络前缀比配。

##### 1.4 运输层
运输层负责向两个主机的进程之间的通信提供**通用**的数据传输服务。

通用：多个应用可以使用同一个运输层服务，而一台主机可以同事运行多个进程，因此运输层有**复用**和**分用**的功能。复用指多个应用进程可同时使用下面运输层的服务，分用则指运输层把收到的信息分别交付上面应用层中的相应进程。

主要使用协议：
- 传输控制协议TCP(Transmission Control Protocol): 提供面向连接的、可靠的数据传输服务，数据传输单位指报文段(segment)。
- 用户数据报协议UDP(User Datagram Protocol): 提供无连接的，尽最大努力的数据传输服务，数据传输的单位是用户数据报。

##### 1.5 应用层
应用层的任务是通过应用进程间的交互来完成特定网络应用。应用层的数据单元是报文(message)

参考：
- https://juejin.im/post/5de372c2f265da060078039a
- https://baike.baidu.com/item/%E7%BD%91%E7%BB%9C%E4%B8%83%E5%B1%82%E5%8D%8F%E8%AE%AE
